# ğŸ” å›¾ç‰‡æ˜¾ç¤ºé—®é¢˜è°ƒè¯•æŒ‡å—

## é—®é¢˜æè¿°

ç”Ÿæˆæ–‡ç« åï¼Œæ–‡ç« ä¸­çš„å›¾ç‰‡æ²¡æœ‰æ˜¾ç¤ºå‡ºæ¥ï¼Œåªæ˜¾ç¤ºäº†å ä½ç¬¦ `![å›¾ç‰‡æè¿°](image_N)`ã€‚

---

## ğŸ§ª è°ƒè¯•æ­¥éª¤

### æ­¥éª¤1ï¼šæ£€æŸ¥å‰ç«¯Consoleæ—¥å¿—

1. æ‰“å¼€æµè§ˆå™¨ï¼ˆå»ºè®®Chromeï¼‰
2. æŒ‰ `F12` æ‰“å¼€å¼€å‘è€…å·¥å…·
3. åˆ‡æ¢åˆ° `Console` æ ‡ç­¾
4. ç”Ÿæˆä¸€ç¯‡æ–‡ç« 
5. æŸ¥çœ‹Consoleè¾“å‡º

**æœŸæœ›çœ‹åˆ°çš„æ—¥å¿—ï¼š**
```
renderArticleWithImages called
previewImages: Array(1) [{mime_type: "image/jpeg", data: "..."}]
content length: 825
Replacing image_1 with base64 data (length: 123456)
Final rendered content length: 123700
Loaded 1 images for preview
```

**å¦‚æœçœ‹åˆ°ï¼š**
```
No preview images, rendering markdown as-is
```
è¯´æ˜ `previewImages` ä¸ºç©ºï¼Œå›¾ç‰‡æ•°æ®æ²¡æœ‰åŠ è½½ï¼

---

### æ­¥éª¤2ï¼šæ£€æŸ¥å›¾ç‰‡æ•°æ®æ˜¯å¦åŠ è½½

åœ¨Consoleä¸­æ‰‹åŠ¨æ£€æŸ¥ï¼š

```javascript
// æŸ¥çœ‹previewImagesçŠ¶æ€
console.log(previewImages)

// åº”è¯¥è¾“å‡ºï¼š
[
  {
    mime_type: "image/jpeg",
    data: "base64ç¼–ç çš„å›¾ç‰‡æ•°æ®ï¼ˆå¾ˆé•¿çš„å­—ç¬¦ä¸²ï¼‰"
  }
]
```

**å¦‚æœè¾“å‡º `[]` æˆ– `null`ï¼Œè¯´æ˜å›¾ç‰‡æ•°æ®æ²¡æœ‰åŠ è½½ï¼**

---

### æ­¥éª¤3ï¼šæ£€æŸ¥ç½‘ç»œè¯·æ±‚

1. åœ¨å¼€å‘è€…å·¥å…·ä¸­ï¼Œåˆ‡æ¢åˆ° `Network` æ ‡ç­¾
2. ç”Ÿæˆä¸€ç¯‡æ–‡ç« 
3. æŸ¥æ‰¾è¯·æ±‚ï¼š
   - `POST /api/ai/create` - åˆ›å»ºæ–‡ç« 
   - `GET /api/ai/preview/{session_id}` - åŠ è½½é¢„è§ˆæ•°æ®ï¼ˆåŒ…å«å›¾ç‰‡ï¼‰

**æ£€æŸ¥ `/api/ai/preview/` è¯·æ±‚ï¼š**
- çŠ¶æ€ç åº”è¯¥æ˜¯ `200 OK`
- Responseåº”è¯¥åŒ…å« `images` æ•°ç»„
- æ¯ä¸ªimageåº”è¯¥æœ‰ `mime_type` å’Œ `data` å­—æ®µ

**ç¤ºä¾‹å“åº”ï¼š**
```json
{
  "session_id": "...",
  "doc_id": "...",
  "article_content": "# æ ‡é¢˜\n\nå†…å®¹...\n\n![å›¾ç‰‡](image_1)",
  "images": [
    {
      "mime_type": "image/jpeg",
      "data": "éå¸¸é•¿çš„base64å­—ç¬¦ä¸²"
    }
  ],
  "original_blocks": [...]
}
```

---

### æ­¥éª¤4ï¼šæ£€æŸ¥åç«¯æ—¥å¿—

æŸ¥çœ‹è¿è¡Œ `python backend_py/main.py` çš„ç»ˆç«¯ï¼š

**ç”Ÿæˆæ–‡ç« æ—¶ï¼Œåº”è¯¥çœ‹åˆ°ï¼š**
```
AI Create request received: doc_id=..., blocks_count=7
Using AI Provider: qwen
Number of images: 1
Calling Qwen VL API... (timeout=60s, images=1)
Added image 1 to content
Qwen VL API response received successfully
```

**é¢„è§ˆè¯·æ±‚æ—¶ï¼Œåº”è¯¥çœ‹åˆ°ï¼š**
```
GET /api/ai/preview/{session_id} - 200 OK
```

---

## ğŸ› å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼š`previewImages` ä¸ºç©º

**åŸå› ï¼š**
- `handleGenerate` ä¸­çš„ `previewArticle` è°ƒç”¨å¤±è´¥
- ç½‘ç»œè¯·æ±‚è¢«æ‹¦æˆªæˆ–è¶…æ—¶

**è§£å†³æ–¹æ¡ˆï¼š**
```typescript
// åœ¨ EditorWorkspace.tsx ä¸­ï¼Œæ‰¾åˆ° handleGenerate å‡½æ•°
// ç¡®è®¤è¿™æ®µä»£ç å­˜åœ¨ï¼š

try {
  const previewData = await aiService.previewArticle(response.session_id)
  setPreviewImages(previewData.images)
  console.log(`Loaded ${previewData.images.length} images for preview`)
} catch (err) {
  console.error('åŠ è½½å›¾ç‰‡å¤±è´¥:', err)
}
```

å¦‚æœçœ‹åˆ° `åŠ è½½å›¾ç‰‡å¤±è´¥` é”™è¯¯ï¼ŒæŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚

---

### é—®é¢˜2ï¼šåç«¯æ²¡æœ‰è¿”å›å›¾ç‰‡æ•°æ®

**æ£€æŸ¥åç«¯ä»£ç ï¼š**

`backend_py/routers/ai.py` ä¸­çš„ `preview_article` å‡½æ•°ï¼š

```python
@router.get("/preview/{session_id}")
async def preview_article(session_id: str):
    session = sessions.get(session_id)
    if not session:
        raise HTTPException(status_code=404, detail="ä¼šè¯ä¸å­˜åœ¨")

    return {
        "session_id": session_id,
        "doc_id": session["doc_id"],
        "article_content": session["current_article"],
        "images": session.get("images", []),  # â† ç¡®è®¤è¿™è¡Œå­˜åœ¨
        "original_blocks": session.get("original_blocks", [])
    }
```

---

### é—®é¢˜3ï¼šå›¾ç‰‡å ä½ç¬¦æ²¡æœ‰è¢«æ›¿æ¢

**å¯èƒ½åŸå› ï¼š**
- æ­£åˆ™è¡¨è¾¾å¼ä¸åŒ¹é…
- å ä½ç¬¦æ ¼å¼ä¸æ­£ç¡®

**æ£€æŸ¥AIç”Ÿæˆçš„å†…å®¹ï¼š**

åœ¨Consoleä¸­ï¼š
```javascript
console.log(article)
```

**æ­£ç¡®çš„å ä½ç¬¦æ ¼å¼ï¼š**
```markdown
![å›¾ç‰‡æè¿°](image_1)
![äº§å“å¤–è§‚](image_2)
```

**é”™è¯¯çš„æ ¼å¼ï¼ˆä¸ä¼šè¢«æ›¿æ¢ï¼‰ï¼š**
```markdown
![å›¾ç‰‡](image1)      â† ç¼ºå°‘ä¸‹åˆ’çº¿
![å›¾ç‰‡](img_1)       â† ä¸æ˜¯"image_"å¼€å¤´
[å›¾ç‰‡](image_1)      â† ç¼ºå°‘æ„Ÿå¹å·
```

---

### é—®é¢˜4ï¼šå›¾ç‰‡æ•°æ®æŸå

**æ£€æŸ¥base64æ•°æ®ï¼š**

åœ¨Consoleä¸­ï¼š
```javascript
// æ£€æŸ¥ç¬¬ä¸€å¼ å›¾ç‰‡çš„æ•°æ®
const img1 = previewImages[0]
console.log('MIME:', img1.mime_type)
console.log('Data length:', img1.data.length)
console.log('Data starts with:', img1.data.substring(0, 50))
```

**æ­£å¸¸çš„è¾“å‡ºï¼š**
```
MIME: image/jpeg
Data length: 123456
Data starts with: /9j/4AAQSkZJRgABAQEAAAAAAAD/2wBD...
```

å¦‚æœ `data` æ˜¯ç©ºå­—ç¬¦ä¸²æˆ–å¾ˆçŸ­ï¼Œè¯´æ˜å›¾ç‰‡ä¸‹è½½å¤±è´¥ã€‚

---

## ğŸ”§ å¿«é€Ÿä¿®å¤

### ä¿®å¤1ï¼šå¼ºåˆ¶åˆ·æ–°é¡µé¢

æœ€ç®€å•çš„æ–¹æ³•ï¼š
1. æŒ‰ `Ctrl + Shift + R` å¼ºåˆ¶åˆ·æ–°å‰ç«¯
2. é‡æ–°ç”Ÿæˆæ–‡ç« 

### ä¿®å¤2ï¼šæ¸…é™¤ç¼“å­˜

å¦‚æœå¼ºåˆ¶åˆ·æ–°æ— æ•ˆï¼š
1. æ‰“å¼€å¼€å‘è€…å·¥å…·
2. å³é”®ç‚¹å‡»åˆ·æ–°æŒ‰é’®
3. é€‰æ‹©"æ¸…ç©ºç¼“å­˜å¹¶ç¡¬æ€§é‡æ–°åŠ è½½"

### ä¿®å¤3ï¼šé‡å¯åç«¯

å¦‚æœåç«¯æœ‰é—®é¢˜ï¼š
1. åœæ­¢åç«¯ï¼ˆ`Ctrl + C`ï¼‰
2. é‡æ–°å¯åŠ¨ï¼š`python backend_py/main.py`
3. ç­‰å¾…å¯åŠ¨å®Œæˆ
4. åˆ·æ–°å‰ç«¯

---

## ğŸ“ è°ƒè¯•Checklist

å®Œæˆä»¥ä¸‹æ£€æŸ¥ï¼š

- [ ] å‰ç«¯Consoleæ²¡æœ‰é”™è¯¯
- [ ] `previewImages` æ•°ç»„ä¸ä¸ºç©º
- [ ] `previewImages[0].data` æœ‰æ•°æ®ï¼ˆé•¿å­—ç¬¦ä¸²ï¼‰
- [ ] Networkä¸­ `/api/ai/preview/` è¿”å›200
- [ ] Responseä¸­ `images` æ•°ç»„æœ‰æ•°æ®
- [ ] åç«¯æ—¥å¿—æ˜¾ç¤º "Added image N to content"
- [ ] åç«¯æ—¥å¿—æ˜¾ç¤º "Qwen VL API response received successfully"
- [ ] AIç”Ÿæˆçš„å†…å®¹åŒ…å« `![...](image_N)` å ä½ç¬¦
- [ ] å ä½ç¬¦æ ¼å¼æ­£ç¡®ï¼ˆæœ‰æ„Ÿå¹å·ï¼Œæœ‰ä¸‹åˆ’çº¿ï¼‰

**å¦‚æœæ‰€æœ‰éƒ½âœ…ï¼Œå›¾ç‰‡åº”è¯¥èƒ½æ­£å¸¸æ˜¾ç¤ºï¼**

---

## ğŸ’¡ æ‰‹åŠ¨æµ‹è¯•

### æµ‹è¯•1ï¼šæ£€æŸ¥å›¾ç‰‡æ˜¯å¦çœŸçš„å­˜åœ¨

åœ¨Consoleä¸­è¿è¡Œï¼š
```javascript
// å‡è®¾æœ‰ä¸€å¼ å›¾ç‰‡
const testImg = new Image()
testImg.src = `data:${previewImages[0].mime_type};base64,${previewImages[0].data}`
testImg.onload = () => console.log('âœ… å›¾ç‰‡åŠ è½½æˆåŠŸï¼å®½åº¦:', testImg.width, 'é«˜åº¦:', testImg.height)
testImg.onerror = () => console.log('âŒ å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œæ•°æ®å¯èƒ½æŸå')
```

### æµ‹è¯•2ï¼šæ‰‹åŠ¨æ›¿æ¢å ä½ç¬¦

åœ¨Consoleä¸­ï¼š
```javascript
const testContent = "# æµ‹è¯•\n\n![æµ‹è¯•å›¾](image_1)\n\nå†…å®¹"
const testRendered = testContent.replace(/!\[([^\]]*)\]\(image_1\)/g, `![test](data:${previewImages[0].mime_type};base64,${previewImages[0].data})`)
console.log('æ›¿æ¢å:', testRendered.substring(0, 200))
```

---

## ğŸ“ å¦‚æœè¿˜æ˜¯ä¸è¡Œ

è¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **å‰ç«¯Consoleå®Œæ•´æ—¥å¿—**ï¼ˆä»ç‚¹å‡»"ç”Ÿæˆ"åˆ°æ–‡ç« æ˜¾ç¤ºï¼‰
2. **Networkæ ‡ç­¾æˆªå›¾**ï¼ˆ`/api/ai/create` å’Œ `/api/ai/preview/` è¯·æ±‚ï¼‰
3. **åç«¯ç»ˆç«¯æ—¥å¿—**ï¼ˆä»æ¥æ”¶è¯·æ±‚åˆ°è¿”å›å“åº”ï¼‰
4. **`previewImages` çš„å®Œæ•´è¾“å‡º**ï¼ˆåœ¨Consoleä¸­è¾“å…¥ `console.log(JSON.stringify(previewImages))`ï¼‰
5. **AIç”Ÿæˆçš„æ–‡ç« å†…å®¹**ï¼ˆåœ¨Consoleä¸­è¾“å…¥ `console.log(article)`ï¼‰

å‘ç»™æˆ‘è¿™äº›ä¿¡æ¯ï¼Œæˆ‘æ¥å¸®ä½ æ’æŸ¥ï¼ ğŸ”

