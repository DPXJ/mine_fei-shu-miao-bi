# 🔍 图片显示问题调试指南

## 问题描述

生成文章后，文章中的图片没有显示出来，只显示了占位符 `![图片描述](image_N)`。

---

## 🧪 调试步骤

### 步骤1：检查前端Console日志

1. 打开浏览器（建议Chrome）
2. 按 `F12` 打开开发者工具
3. 切换到 `Console` 标签
4. 生成一篇文章
5. 查看Console输出

**期望看到的日志：**
```
renderArticleWithImages called
previewImages: Array(1) [{mime_type: "image/jpeg", data: "..."}]
content length: 825
Replacing image_1 with base64 data (length: 123456)
Final rendered content length: 123700
Loaded 1 images for preview
```

**如果看到：**
```
No preview images, rendering markdown as-is
```
说明 `previewImages` 为空，图片数据没有加载！

---

### 步骤2：检查图片数据是否加载

在Console中手动检查：

```javascript
// 查看previewImages状态
console.log(previewImages)

// 应该输出：
[
  {
    mime_type: "image/jpeg",
    data: "base64编码的图片数据（很长的字符串）"
  }
]
```

**如果输出 `[]` 或 `null`，说明图片数据没有加载！**

---

### 步骤3：检查网络请求

1. 在开发者工具中，切换到 `Network` 标签
2. 生成一篇文章
3. 查找请求：
   - `POST /api/ai/create` - 创建文章
   - `GET /api/ai/preview/{session_id}` - 加载预览数据（包含图片）

**检查 `/api/ai/preview/` 请求：**
- 状态码应该是 `200 OK`
- Response应该包含 `images` 数组
- 每个image应该有 `mime_type` 和 `data` 字段

**示例响应：**
```json
{
  "session_id": "...",
  "doc_id": "...",
  "article_content": "# 标题\n\n内容...\n\n![图片](image_1)",
  "images": [
    {
      "mime_type": "image/jpeg",
      "data": "非常长的base64字符串"
    }
  ],
  "original_blocks": [...]
}
```

---

### 步骤4：检查后端日志

查看运行 `python backend_py/main.py` 的终端：

**生成文章时，应该看到：**
```
AI Create request received: doc_id=..., blocks_count=7
Using AI Provider: qwen
Number of images: 1
Calling Qwen VL API... (timeout=60s, images=1)
Added image 1 to content
Qwen VL API response received successfully
```

**预览请求时，应该看到：**
```
GET /api/ai/preview/{session_id} - 200 OK
```

---

## 🐛 常见问题和解决方案

### 问题1：`previewImages` 为空

**原因：**
- `handleGenerate` 中的 `previewArticle` 调用失败
- 网络请求被拦截或超时

**解决方案：**
```typescript
// 在 EditorWorkspace.tsx 中，找到 handleGenerate 函数
// 确认这段代码存在：

try {
  const previewData = await aiService.previewArticle(response.session_id)
  setPreviewImages(previewData.images)
  console.log(`Loaded ${previewData.images.length} images for preview`)
} catch (err) {
  console.error('加载图片失败:', err)
}
```

如果看到 `加载图片失败` 错误，查看详细错误信息。

---

### 问题2：后端没有返回图片数据

**检查后端代码：**

`backend_py/routers/ai.py` 中的 `preview_article` 函数：

```python
@router.get("/preview/{session_id}")
async def preview_article(session_id: str):
    session = sessions.get(session_id)
    if not session:
        raise HTTPException(status_code=404, detail="会话不存在")

    return {
        "session_id": session_id,
        "doc_id": session["doc_id"],
        "article_content": session["current_article"],
        "images": session.get("images", []),  # ← 确认这行存在
        "original_blocks": session.get("original_blocks", [])
    }
```

---

### 问题3：图片占位符没有被替换

**可能原因：**
- 正则表达式不匹配
- 占位符格式不正确

**检查AI生成的内容：**

在Console中：
```javascript
console.log(article)
```

**正确的占位符格式：**
```markdown
![图片描述](image_1)
![产品外观](image_2)
```

**错误的格式（不会被替换）：**
```markdown
![图片](image1)      ← 缺少下划线
![图片](img_1)       ← 不是"image_"开头
[图片](image_1)      ← 缺少感叹号
```

---

### 问题4：图片数据损坏

**检查base64数据：**

在Console中：
```javascript
// 检查第一张图片的数据
const img1 = previewImages[0]
console.log('MIME:', img1.mime_type)
console.log('Data length:', img1.data.length)
console.log('Data starts with:', img1.data.substring(0, 50))
```

**正常的输出：**
```
MIME: image/jpeg
Data length: 123456
Data starts with: /9j/4AAQSkZJRgABAQEAAAAAAAD/2wBD...
```

如果 `data` 是空字符串或很短，说明图片下载失败。

---

## 🔧 快速修复

### 修复1：强制刷新页面

最简单的方法：
1. 按 `Ctrl + Shift + R` 强制刷新前端
2. 重新生成文章

### 修复2：清除缓存

如果强制刷新无效：
1. 打开开发者工具
2. 右键点击刷新按钮
3. 选择"清空缓存并硬性重新加载"

### 修复3：重启后端

如果后端有问题：
1. 停止后端（`Ctrl + C`）
2. 重新启动：`python backend_py/main.py`
3. 等待启动完成
4. 刷新前端

---

## 📝 调试Checklist

完成以下检查：

- [ ] 前端Console没有错误
- [ ] `previewImages` 数组不为空
- [ ] `previewImages[0].data` 有数据（长字符串）
- [ ] Network中 `/api/ai/preview/` 返回200
- [ ] Response中 `images` 数组有数据
- [ ] 后端日志显示 "Added image N to content"
- [ ] 后端日志显示 "Qwen VL API response received successfully"
- [ ] AI生成的内容包含 `![...](image_N)` 占位符
- [ ] 占位符格式正确（有感叹号，有下划线）

**如果所有都✅，图片应该能正常显示！**

---

## 💡 手动测试

### 测试1：检查图片是否真的存在

在Console中运行：
```javascript
// 假设有一张图片
const testImg = new Image()
testImg.src = `data:${previewImages[0].mime_type};base64,${previewImages[0].data}`
testImg.onload = () => console.log('✅ 图片加载成功！宽度:', testImg.width, '高度:', testImg.height)
testImg.onerror = () => console.log('❌ 图片加载失败，数据可能损坏')
```

### 测试2：手动替换占位符

在Console中：
```javascript
const testContent = "# 测试\n\n![测试图](image_1)\n\n内容"
const testRendered = testContent.replace(/!\[([^\]]*)\]\(image_1\)/g, `![test](data:${previewImages[0].mime_type};base64,${previewImages[0].data})`)
console.log('替换后:', testRendered.substring(0, 200))
```

---

## 📞 如果还是不行

请提供以下信息：

1. **前端Console完整日志**（从点击"生成"到文章显示）
2. **Network标签截图**（`/api/ai/create` 和 `/api/ai/preview/` 请求）
3. **后端终端日志**（从接收请求到返回响应）
4. **`previewImages` 的完整输出**（在Console中输入 `console.log(JSON.stringify(previewImages))`）
5. **AI生成的文章内容**（在Console中输入 `console.log(article)`）

发给我这些信息，我来帮你排查！ 🔍

