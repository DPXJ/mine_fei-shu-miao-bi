# âœ… ä¿®å¤å®Œæˆï¼šé£ä¹¦æ–‡æ¡£å¯¼å‡ºå’Œå›¾ç‰‡ä¸Šä¼ 

## ğŸ› é—®é¢˜è¯Šæ–­

ä»åç«¯æ—¥å¿—å‘ç°äº†ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼š

### é—®é¢˜1ï¼šå›¾ç‰‡ä¸Šä¼ å¤±è´¥ âŒ
```
Upload image 1 response: {'code': 1061002, 'msg': 'params error.'}
```

**åŸå› ï¼š**
- ä¸Šä¼ å›¾ç‰‡æ—¶ç¼ºå°‘å¿…è¦çš„å‚æ•° `parent_type` å’Œ `parent_node`
- é£ä¹¦è¦æ±‚ä¸Šä¼ å›¾ç‰‡åˆ°æ–‡æ¡£æ—¶ï¼Œå¿…é¡»æŒ‡å®šçˆ¶æ–‡æ¡£ä¿¡æ¯

### é—®é¢˜2ï¼šå†…å®¹åˆ›å»ºå¤±è´¥ âŒ
```
Create blocks response: {'code': 99992402, 'msg': 'field validation failed', 
  'field_violations': [{'field': 'children', 'description': 'the max len is 50'}]}
```

**åŸå› ï¼š**
- é£ä¹¦APIé™åˆ¶ï¼šä¸€æ¬¡æœ€å¤šåªèƒ½åˆ›å»º50ä¸ªblock
- ä¹‹å‰ä»£ç ä¸€æ¬¡æ€§åˆ›å»ºäº†100ä¸ªblockï¼Œè¶…å‡ºé™åˆ¶

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1ï¼šå›¾ç‰‡ä¸Šä¼ å‚æ•°è¡¥å…¨

**æ–‡ä»¶ï¼š** `backend_py/routers/documents.py`

**ä¿®æ”¹å‰ï¼š**
```python
upload_response = await client.post(
    "https://open.feishu.cn/open-apis/drive/v1/medias/upload_all",
    headers={"Authorization": f"Bearer {token}"},
    files=files,
    data={
        'file_type': 'image',
        'file_name': f'image_{idx+1}.jpg'
    }
)
```

**ä¿®æ”¹åï¼š**
```python
upload_response = await client.post(
    "https://open.feishu.cn/open-apis/drive/v1/medias/upload_all",
    headers={"Authorization": f"Bearer {token}"},
    files=files,
    data={
        "file_name": f'image_{idx+1}.jpg',
        "parent_type": "docx_image",      # â† å¿…é¡»ï¼šæŒ‡å®šçˆ¶ç±»å‹
        "parent_node": doc_id,            # â† å¿…é¡»ï¼šæŒ‡å®šçˆ¶æ–‡æ¡£ID
        "size": str(len(img_data))        # â† å¿…é¡»ï¼šæ–‡ä»¶å¤§å°
    }
)

# é™é€Ÿï¼šé¿å…è§¦å‘é¢‘ç‡é™åˆ¶
time.sleep(0.3)
```

**å…³é”®æ”¹è¿›ï¼š**
- âœ… æ·»åŠ  `parent_type: "docx_image"` - æŒ‡å®šå›¾ç‰‡æ˜¯æ–‡æ¡£å›¾ç‰‡
- âœ… æ·»åŠ  `parent_node: doc_id` - å…³è”åˆ°ç›®æ ‡æ–‡æ¡£
- âœ… æ·»åŠ  `size` - å›¾ç‰‡æ–‡ä»¶å¤§å°
- âœ… æ·»åŠ å»¶è¿Ÿ0.3ç§’ - é¿å…è§¦å‘é£ä¹¦é¢‘ç‡é™åˆ¶

---

### ä¿®å¤2ï¼šåˆ†æ‰¹åˆ›å»ºblocks

**æ–‡ä»¶ï¼š** `backend_py/routers/documents.py`

**ä¿®æ”¹å‰ï¼š**
```python
children_response = await client.post(
    f"https://open.feishu.cn/open-apis/docx/v1/documents/{doc_id}/blocks/{root_block_id}/children",
    headers={
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json"
    },
    json={
        "children": blocks_to_create[:100],  # âŒ æœ€å¤š100ä¸ªï¼ˆè¶…å‡ºé™åˆ¶ï¼‰
        "index": 0
    }
)
```

**ä¿®æ”¹åï¼š**
```python
# åˆ†æ‰¹åˆ›å»ºï¼ˆæ¯æ‰¹æœ€å¤š50ä¸ªï¼‰
batch_size = 50
total_batches = (len(blocks_to_create) + batch_size - 1) // batch_size

for batch_idx in range(total_batches):
    start_idx = batch_idx * batch_size
    end_idx = min(start_idx + batch_size, len(blocks_to_create))
    batch_blocks = blocks_to_create[start_idx:end_idx]
    
    print(f"Creating batch {batch_idx + 1}/{total_batches}: {len(batch_blocks)} blocks")
    
    children_response = await client.post(
        f"https://open.feishu.cn/open-apis/docx/v1/documents/{doc_id}/blocks/{root_block_id}/children",
        headers={
            "Authorization": f"Bearer {token}",
            "Content-Type": "application/json"
        },
        json={
            "children": batch_blocks,    # âœ… æ¯æ‰¹æœ€å¤š50ä¸ª
            "index": start_idx           # âœ… æŒ‡å®šæ’å…¥ä½ç½®
        }
    )
    
    children_data = children_response.json()
    print(f"Batch {batch_idx + 1} response: {children_data}")
    
    if children_data.get("code") != 0:
        print(f"âŒ Batch {batch_idx + 1} failed: {children_data.get('msg')}")
        break
    else:
        print(f"âœ… Batch {batch_idx + 1} created successfully")
    
    # æ‰¹æ¬¡é—´å»¶è¿Ÿï¼Œé¿å…è§¦å‘é¢‘ç‡é™åˆ¶
    if batch_idx < total_batches - 1:
        time.sleep(0.5)
```

**å…³é”®æ”¹è¿›ï¼š**
- âœ… æ¯æ‰¹æœ€å¤šåˆ›å»º50ä¸ªblockï¼ˆç¬¦åˆé£ä¹¦é™åˆ¶ï¼‰
- âœ… è‡ªåŠ¨è®¡ç®—éœ€è¦å¤šå°‘æ‰¹æ¬¡
- âœ… æŒ‰é¡ºåºæ’å…¥ï¼Œä¿æŒå†…å®¹é¡ºåº
- âœ… è¯¦ç»†æ—¥å¿—è¾“å‡ºï¼Œæ–¹ä¾¿æŸ¥çœ‹è¿›åº¦
- âœ… æ‰¹æ¬¡é—´å»¶è¿Ÿ0.5ç§’ï¼Œé¿å…é¢‘ç‡é™åˆ¶

---

## ğŸ“Š åç«¯æ—¥å¿—è§£è¯»

### å¦‚ä½•æŸ¥çœ‹åç«¯å®æ—¶æ—¥å¿—

**æ–¹æ³•1ï¼šåœ¨ä½ çš„æˆªå›¾ç»ˆç«¯çª—å£ä¸­æŸ¥çœ‹** âœ…
- ä½ å·²ç»è¿è¡Œäº† `python backend_py/main.py`
- ç»ˆç«¯ä¼šå®æ—¶æ˜¾ç¤ºæ‰€æœ‰æ—¥å¿—
- **ä¸éœ€è¦**é¢å¤–çš„å‘½ä»¤

**æ–¹æ³•2ï¼šå¦‚æœæ—¥å¿—åœæ­¢æ›´æ–°**
- æ»šåŠ¨ç»ˆç«¯æŸ¥çœ‹ä¹‹å‰çš„æ—¥å¿—
- æˆ–è€…é‡æ–°è¿è¡Œ `cd backend_py ; python main.py`

---

### æˆåŠŸçš„æ—¥å¿—åº”è¯¥æ˜¯è¿™æ ·çš„

#### âœ… åˆ›å»ºæ–‡æ¡£æˆåŠŸ
```
Create document response: {'code': 0, 'data': {'document': {'document_id': 'xxx', ...}}, 'msg': 'success'}
```

#### âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ
```
Upload image 1 response: {'code': 0, 'data': {'file_token': 'xxx'}, 'msg': 'success'}
Image 1 uploaded successfully: xxx
Upload image 2 response: {'code': 0, ...}
Image 2 uploaded successfully: xxx
```

#### âœ… å†…å®¹åˆ›å»ºæˆåŠŸ
```
Creating batch 1/3: 50 blocks
Batch 1 response: {'code': 0, 'msg': 'success'}
âœ… Batch 1 created successfully

Creating batch 2/3: 50 blocks
Batch 2 response: {'code': 0, 'msg': 'success'}
âœ… Batch 2 created successfully

Creating batch 3/3: 30 blocks
Batch 3 response: {'code': 0, 'msg': 'success'}
âœ… Batch 3 created successfully
```

---

### å¤±è´¥çš„æ—¥å¿—ï¼ˆå·²ä¿®å¤ï¼‰

#### âŒ å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼ˆå·²ä¿®å¤ï¼‰
```
Upload image 1 response: {'code': 1061002, 'msg': 'params error.'}
Image 1 upload failed: params error.
```
**ç°åœ¨åº”è¯¥æ˜¾ç¤ºï¼š** âœ… `Image 1 uploaded successfully: xxx`

#### âŒ å†…å®¹åˆ›å»ºå¤±è´¥ï¼ˆå·²ä¿®å¤ï¼‰
```
Create blocks response: {'code': 99992402, 'msg': 'field validation failed', 
  'field_violations': [{'field': 'children', 'description': 'the max len is 50'}]}
```
**ç°åœ¨åº”è¯¥æ˜¾ç¤ºï¼š** âœ… `Batch 1/2 created successfully`

#### âŒ é¢‘ç‡é™åˆ¶ï¼ˆå·²ä¼˜åŒ–ï¼‰
```
Upload image 9 response: {'code': 99991400, 'msg': 'request trigger frequency limit'}
```
**ç°åœ¨åº”è¯¥ä¸ä¼šå‡ºç°ï¼š** å› ä¸ºæ·»åŠ äº† `time.sleep(0.3)` å»¶è¿Ÿ

---

## ğŸ§ª ç«‹å³æµ‹è¯•

### æ­¥éª¤1ï¼šç¡®è®¤åç«¯å·²è¿è¡Œ
æŸ¥çœ‹ä½ çš„ç»ˆç«¯çª—å£ï¼ˆæˆªå›¾é‚£ä¸ªï¼‰ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
```
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [31508] using StatReload
INFO:     Started server process [64336]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
```

âœ… å¦‚æœçœ‹åˆ°è¿™äº›ï¼Œåç«¯æ­£åœ¨è¿è¡Œ

---

### æ­¥éª¤2ï¼šé‡æ–°ç”Ÿæˆæ–‡ç« å¹¶åˆ›å»ºé£ä¹¦å‰¯æœ¬

1. **æ‰“å¼€å‰ç«¯** http://localhost:3000
2. **é€‰æ‹©ä¸€ä¸ªåŒ…å«å›¾ç‰‡çš„æ–‡æ¡£**
3. **è¾“å…¥æŒ‡ä»¤**ï¼š`æ•´ç†æˆä¸€ç¯‡ä¸“ä¸šçš„äº§å“ä»‹ç»`
4. **ç‚¹å‡»"ç”Ÿæˆ"**
5. **ç­‰å¾…ç”Ÿæˆå®Œæˆ**ï¼ˆæŸ¥çœ‹åç«¯æ—¥å¿—ï¼‰
6. **ç‚¹å‡»"åˆ›å»ºé£ä¹¦å‰¯æœ¬"** æŒ‰é’®

---

### æ­¥éª¤3ï¼šæŸ¥çœ‹åç«¯æ—¥å¿—ï¼ˆåŒæ—¶æ“ä½œï¼‰

**åœ¨ç‚¹å‡»"åˆ›å»ºé£ä¹¦å‰¯æœ¬"åï¼Œç«‹å³æŸ¥çœ‹ç»ˆç«¯æ—¥å¿—ï¼š**

ä½ åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„æ—¥å¿—ï¼ˆ**å®æ—¶æ˜¾ç¤º**ï¼‰ï¼š

```
INFO:     127.0.0.1:xxxx - "POST /api/documents/create HTTP/1.1" 200 OK

Create document response: {'code': 0, 'data': {'document': {'document_id': 'NzZTdKE4JouDGsxflTRcEMIzntg', ...}}, 'msg': 'success'}

Upload image 1 response: {'code': 0, 'data': {'file_token': 'abc123'}, 'msg': 'success'}
Image 1 uploaded successfully: abc123

Upload image 2 response: {'code': 0, 'data': {'file_token': 'def456'}, 'msg': 'success'}
Image 2 uploaded successfully: def456

Creating batch 1/2: 50 blocks
Batch 1 response: {'code': 0, 'msg': 'success'}
âœ… Batch 1 created successfully

Creating batch 2/2: 30 blocks
Batch 2 response: {'code': 0, 'msg': 'success'}
âœ… Batch 2 created successfully
```

---

### æ­¥éª¤4ï¼šéªŒè¯é£ä¹¦æ–‡æ¡£

**ç‚¹å‡»å¼¹çª—ä¸­çš„é£ä¹¦æ–‡æ¡£é“¾æ¥ï¼Œæ£€æŸ¥ï¼š**

âœ… **æ ‡é¢˜æ­£ç¡®**ï¼š`åŸæ–‡æ¡£å - AIåˆ›ä½œå‰¯æœ¬`
âœ… **æ–‡æœ¬å®Œæ•´**ï¼šæ‰€æœ‰æ®µè½éƒ½æ˜¾ç¤º
âœ… **å›¾ç‰‡æ˜¾ç¤º**ï¼šæ‰€æœ‰å›¾ç‰‡éƒ½æ­£ç¡®æ’å…¥
âœ… **æ ¼å¼ç¾è§‚**ï¼šæ ‡é¢˜ã€æ®µè½å±‚æ¬¡æ¸…æ™°

---

## ğŸ¯ æµ‹è¯•æ£€æŸ¥æ¸…å•

å®Œæˆä»¥ä¸‹æ‰€æœ‰é¡¹ï¼Œè¯´æ˜ä¿®å¤æˆåŠŸï¼š

### åç«¯æ—¥å¿—æ£€æŸ¥
- [ ] çœ‹åˆ° `Create document response: {'code': 0}`
- [ ] çœ‹åˆ° `Image 1 uploaded successfully: xxx`
- [ ] çœ‹åˆ° `âœ… Batch 1 created successfully`
- [ ] **æ²¡æœ‰** `params error` é”™è¯¯
- [ ] **æ²¡æœ‰** `the max len is 50` é”™è¯¯
- [ ] **æ²¡æœ‰** `frequency limit` é”™è¯¯

### é£ä¹¦æ–‡æ¡£æ£€æŸ¥
- [ ] æ–‡æ¡£åˆ›å»ºæˆåŠŸ
- [ ] æ–‡æ¡£æ ‡é¢˜æ­£ç¡®
- [ ] æ‰€æœ‰æ–‡æœ¬å†…å®¹å®Œæ•´
- [ ] æ‰€æœ‰å›¾ç‰‡æ­£ç¡®æ˜¾ç¤º
- [ ] æ ¼å¼æ¸…æ™°ç¾è§‚

### å‰ç«¯æ£€æŸ¥
- [ ] ç‚¹å‡»"åˆ›å»ºé£ä¹¦å‰¯æœ¬"æŒ‰é’®åæœ‰loadingæç¤º
- [ ] 5-15ç§’åæ˜¾ç¤ºæˆåŠŸæç¤º
- [ ] å¼¹çª—ä¸­æœ‰é£ä¹¦æ–‡æ¡£é“¾æ¥
- [ ] ç‚¹å‡»é“¾æ¥èƒ½æ‰“å¼€æ–°æ–‡æ¡£

---

## ğŸš¨ å¸¸è§é—®é¢˜æ’æŸ¥

### Q1ï¼šåç«¯æ—¥å¿—ä¸æ›´æ–°æ€ä¹ˆåŠï¼Ÿ
**A:** 
1. æ»šåŠ¨ç»ˆç«¯çª—å£ï¼ŒæŸ¥çœ‹ä¹‹å‰çš„æ—¥å¿—
2. æˆ–è€…ç‚¹å‡»ç»ˆç«¯ï¼ŒæŒ‰ `Ctrl+C` åœæ­¢ï¼Œç„¶åé‡æ–°è¿è¡Œï¼š
   ```bash
   cd backend_py
   python main.py
   ```

### Q2ï¼šè¿˜æ˜¯çœ‹åˆ° `params error`ï¼Ÿ
**A:** 
1. ç¡®è®¤åç«¯å·²ç»é‡å¯ï¼ˆçœ‹åˆ° `Application startup complete.`ï¼‰
2. æ¸…ç©ºæµè§ˆå™¨ç¼“å­˜ï¼Œåˆ·æ–°å‰ç«¯ï¼ˆ`Ctrl + Shift + R`ï¼‰
3. é‡æ–°ç”Ÿæˆæ–‡ç« ï¼Œå†ç‚¹å‡»"åˆ›å»ºé£ä¹¦å‰¯æœ¬"

### Q3ï¼šè¿˜æ˜¯çœ‹åˆ° `the max len is 50`ï¼Ÿ
**A:** 
1. ç¡®è®¤åç«¯ä»£ç å·²æ›´æ–°ï¼ˆæŸ¥çœ‹ `backend_py/routers/documents.py` ç¬¬433è¡Œé™„è¿‘æ˜¯å¦æœ‰ `batch_size = 50`ï¼‰
2. é‡å¯åç«¯
3. é‡è¯•åˆ›å»º

### Q4ï¼šå›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼Œä½†å†…å®¹åˆ›å»ºå¤±è´¥ï¼Ÿ
**A:** 
å¯èƒ½æ˜¯æ–‡æœ¬å†…å®¹è§£ææœ‰é—®é¢˜ï¼ŒæŸ¥çœ‹æ—¥å¿—ä¸­ï¼š
```
Creating batch 1/2: 50 blocks
Batch 1 response: {'code': xxx, 'msg': 'xxx'}
```
å¦‚æœ `code` ä¸æ˜¯ 0ï¼Œå¤åˆ¶å®Œæ•´çš„é”™è¯¯ä¿¡æ¯å‘Šè¯‰æˆ‘ã€‚

### Q5ï¼šé£ä¹¦æ–‡æ¡£åˆ›å»ºæˆåŠŸï¼Œä½†å›¾ç‰‡æ˜¯ç°è‰²çš„ï¼Ÿ
**A:** 
è¿™è¯´æ˜å›¾ç‰‡ä¸Šä¼ å¤±è´¥äº†ï¼Œæ£€æŸ¥æ—¥å¿—ï¼š
```
Image 1 upload failed: xxx
```
å¤åˆ¶å®Œæ•´çš„é”™è¯¯ä¿¡æ¯å‘Šè¯‰æˆ‘ã€‚

---

## ğŸ“ æŠ€æœ¯è¦ç‚¹

### é£ä¹¦å›¾ç‰‡ä¸Šä¼ APIè¦æ±‚
```python
{
    "file_name": "xxx.jpg",        # å¿…é¡»
    "parent_type": "docx_image",   # å¿…é¡»ï¼šæŒ‡å®šä¸ºæ–‡æ¡£å›¾ç‰‡
    "parent_node": "æ–‡æ¡£ID",        # å¿…é¡»ï¼šå…³è”åˆ°ç›®æ ‡æ–‡æ¡£
    "size": "æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰"        # å¿…é¡»
}
```

### é£ä¹¦æ‰¹é‡åˆ›å»ºblocksé™åˆ¶
- ä¸€æ¬¡æœ€å¤š50ä¸ªblock
- éœ€è¦åˆ†æ‰¹åˆ›å»º
- æ‰¹æ¬¡é—´å»ºè®®å»¶è¿Ÿ0.5ç§’

### é¢‘ç‡é™åˆ¶å¤„ç†
- å›¾ç‰‡ä¸Šä¼ é—´éš”0.3ç§’
- æ‰¹æ¬¡åˆ›å»ºé—´éš”0.5ç§’
- é¿å…è§¦å‘ `99991400 frequency limit`

---

**åç«¯å·²é‡å¯å¹¶è¿è¡Œåœ¨ http://localhost:8000 âœ…**

**ç°åœ¨å»æµ‹è¯•å§ï¼** ğŸš€

è®°å¾—**è¾¹æ“ä½œè¾¹çœ‹åç«¯æ—¥å¿—**ï¼Œè¿™æ ·èƒ½å®æ—¶çœ‹åˆ°æ‰§è¡Œæƒ…å†µï¼

æœ‰ä»»ä½•é—®é¢˜éšæ—¶å‘Šè¯‰æˆ‘ï¼

