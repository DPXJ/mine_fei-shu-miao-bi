# 飞书妙笔 - 配置指南

## 1. 飞书开放平台配置

### 1.1 创建应用

1. 访问 [飞书开放平台](https://open.feishu.cn/)
2. 点击"创建企业自建应用"
3. 填写应用基本信息：
   - 应用名称：飞书妙笔
   - 应用描述：智能内容创作辅助工具
   - 应用图标：上传logo（可选）

### 1.2 配置应用权限

进入"权限管理"，添加以下权限：

**必需权限：**
- `docx:document` - 查看、评论和编辑文档
- `drive:drive` - 查看、评论、编辑和管理云空间中的文件
- `auth:user.id` - 获取用户ID

### 1.3 配置重定向URL

在"安全设置"中添加重定向URL：
```
http://localhost:3000/auth/callback
```

生产环境请改为您的实际域名：
```
https://your-domain.com/auth/callback
```

### 1.4 获取凭证

在"凭证与基础信息"页面获取：
- **App ID**
- **App Secret**

## 2. Google Gemini API配置

### 2.1 获取API Key

1. 访问 [Google AI Studio](https://makersuite.google.com/app/apikey)
2. 登录Google账号
3. 点击"Create API Key"
4. 复制生成的API Key

### 2.2 配额说明

- 免费额度：每分钟60次请求
- 如需更高配额，请升级到付费计划

## 3. 环境变量配置

### 3.1 后端配置

复制 `backend_py/.env.example` 为 `backend_py/.env`，填写以下内容：

```env
# 飞书应用配置
FEISHU_APP_ID=cli_xxxxxxxxxxxxx
FEISHU_APP_SECRET=xxxxxxxxxxxxx
FEISHU_REDIRECT_URI=http://localhost:3000/auth/callback

# Google Gemini配置
GEMINI_API_KEY=AIzaSyxxxxxxxxxxxxx

# 服务配置
BACKEND_URL=http://localhost:8000
FRONTEND_URL=http://localhost:3000
```

### 3.2 前端配置

复制 `frontend/.env.local.example` 为 `frontend/.env.local`：

```env
NEXT_PUBLIC_API_URL=http://localhost:8000
```

## 4. 依赖安装

### 方式一：使用安装脚本（推荐）

双击运行 `安装依赖.bat`

### 方式二：手动安装

**后端依赖：**
```bash
cd backend_py
python -m venv venv
venv\Scripts\activate  # Windows
# source venv/bin/activate  # Linux/Mac
pip install -r requirements.txt
```

**前端依赖：**
```bash
cd frontend
npm install
```

## 5. 启动应用

### 方式一：使用启动脚本（推荐）

**Windows:**
- 双击 `启动项目.bat`

**PowerShell:**
- 右键以PowerShell运行 `start_all.ps1`

### 方式二：分别启动

**启动后端：**
```bash
cd backend_py
python main.py
```

**启动前端：**
```bash
cd frontend
npm run dev
```

## 6. 访问应用

打开浏览器访问：[http://localhost:3000](http://localhost:3000)

## 7. 常见问题

### Q1: 飞书登录失败

**可能原因：**
- App ID 或 App Secret 配置错误
- 重定向URI不匹配
- 应用权限未开通

**解决方案：**
- 检查 `.env` 文件配置
- 确认飞书后台的重定向URL配置
- 确认已添加必需的应用权限

### Q2: AI生成失败

**可能原因：**
- Gemini API Key 无效或过期
- API配额用尽
- 网络连接问题

**解决方案：**
- 检查API Key是否正确
- 查看Google AI Studio的配额使用情况
- 确认网络可以访问Google服务

### Q3: 图片无法显示

**可能原因：**
- 飞书token过期
- 文档权限不足
- 图片下载失败

**解决方案：**
- 重新登录飞书账号
- 确认对文档有访问权限
- 查看后端日志排查错误

### Q4: 端口占用

**错误信息：**
```
Error: listen EADDRINUSE: address already in use :::3000
```

**解决方案：**
```bash
# 查找占用端口的进程
netstat -ano | findstr :3000

# 结束进程
taskkill /PID <进程ID> /F
```

## 8. 生产环境部署

### 8.1 环境变量更新

将所有 `localhost` 改为实际域名：

```env
FEISHU_REDIRECT_URI=https://your-domain.com/auth/callback
BACKEND_URL=https://api.your-domain.com
FRONTEND_URL=https://your-domain.com
```

### 8.2 飞书应用配置更新

在飞书开放平台更新：
- 重定向URL：`https://your-domain.com/auth/callback`
- 应用发布：提交审核并发布应用

### 8.3 部署建议

**前端：**
- Vercel (推荐)
- Netlify
- 自建服务器 + Nginx

**后端：**
- Google Cloud Run
- AWS Lambda + API Gateway
- 自建服务器 + Docker

## 9. 技术支持

如有问题，请查看：
- [飞书开放平台文档](https://open.feishu.cn/document/)
- [Google Gemini API文档](https://ai.google.dev/docs)
- [Next.js文档](https://nextjs.org/docs)
- [FastAPI文档](https://fastapi.tiangolo.com/)


