# ✅ 修复完成：图片显示 + 飞书导出

## 🔧 问题汇总

您报告了两个关键问题：

### 问题1：图片在前端不显示
**现象：**
- 生成文章后，看到的是 `http://localhost:3000/image1.jpg` 404错误
- 图片没有显示在文章中
- 只有占位符，没有实际图片

**根本原因：**
- AI生成的图片格式不正确
- 应该是 `![描述](image_1)`，但AI生成了 `![描述](image1.jpg)` 或其他格式
- 前端的正则替换无法匹配错误格式

### 问题2：创建飞书副本没有内容
**现象：**
- 点击"创建飞书副本"成功创建文档
- 文档有标题
- 但没有任何文本内容和图片

**根本原因：**
- 飞书API的 `block_type` 值不正确
- 文本块应该是 `1`，但代码中使用了 `2`
- 导致内容无法正确写入

---

## ✅ 修复内容

### 修复1：AI提示词优化

**文件：** `backend_py/routers/ai.py`

**修改：**
1. 在system_prompt中添加了更严格的图片格式要求：
```python
⚠️ 重要：图片格式要求
- **必须**使用这个精确格式标记图片：![图片描述](image_1)、![图片描述](image_2)
- 图片编号从1开始，依次为 image_1, image_2, image_3...
- ❌ 错误示例：![图片](image1.jpg)、![图片](img_1)、![图片](picture1)
- ✅ 正确示例：![产品外观](image_1)、![功能演示](image_2)
```

2. 在refine prompt中也添加了同样的格式要求

---

### 修复2：自动格式修正

**文件：** `backend_py/routers/ai.py`

**修改：**
即使AI没有严格遵守格式，后端也会自动修正：

```python
# 修正可能的图片格式错误
import re
# 修正 image1.jpg -> image_1
generated_text = re.sub(r'!\[([^\]]*)\]\(image(\d+)\.(?:jpg|png|jpeg|gif)\)', r'![\1](image_\2)', generated_text)
# 修正 img_1 -> image_1
generated_text = re.sub(r'!\[([^\]]*)\]\(img_(\d+)\)', r'![\1](image_\2)', generated_text)
# 修正 picture1 -> image_1
generated_text = re.sub(r'!\[([^\]]*)\]\(picture(\d+)\)', r'![\1](image_\2)', generated_text)
```

**应用位置：**
- `create_article` 接口（首次生成）
- `refine_article` 接口（精修）

---

### 修复3：飞书block_type修正

**文件：** `backend_py/routers/documents.py`

**修改前：**
```python
blocks_to_create.append({
    "block_type": 2,  # ❌ 错误：2是标题
    "text": {
        "elements": [{"text_run": {"content": line}}]
    }
})
```

**修改后：**
```python
blocks_to_create.append({
    "block_type": 1,  # ✅ 正确：1是文本
    "text": {
        "elements": [{"text_run": {"content": line}}]
    }
})
```

**同时修正了标题判断顺序：**
- 先判断 `###`（三级标题）
- 再判断 `##`（二级标题）
- 最后判断 `#`（一级标题）
- 避免 `###` 被错误匹配为 `#`

---

## 🧪 测试步骤

### 步骤1：刷新前端
```bash
# 按 Ctrl + Shift + R 强制刷新浏览器
```

### 步骤2：重新生成文章
1. 访问 http://localhost:3000
2. 选择一个包含图片的文档
3. 输入指令：`创作一篇产品介绍，把图片插入到合适的位置`
4. 点击"生成"

**期望结果：**
- ✅ 文章成功生成
- ✅ **图片自动显示**在文章中（不是占位符）
- ✅ 图片清晰可见
- ✅ 图片位置合理

**如何验证图片格式：**
打开F12 Console，应该看到：
```
renderArticleWithImages called
previewImages: Array(1) [{mime_type: "image/jpeg", data: "..."}]
Replacing image_1 with base64 data (length: 123456)
```

---

### 步骤3：测试创建飞书副本
1. 生成文章后，点击右上角 **"创建飞书副本"** 按钮
2. 等待5-15秒
3. 看到成功提示，点击链接打开飞书文档

**期望结果：**
- ✅ 创建成功
- ✅ **文档标题正确**
- ✅ **文本内容完整**显示
- ✅ **图片正确导入**
- ✅ **格式清晰美观**

**在飞书中检查：**
- [ ] 标题：`原文档名 - AI创作副本`
- [ ] 所有段落都显示
- [ ] 所有图片都显示
- [ ] 图片位置与AI排版一致

---

### 步骤4：测试多轮对话
1. 继续输入：`把第一张图片移到文章开头`
2. 点击发送

**期望结果：**
- ✅ 成功精修
- ✅ 图片位置调整
- ✅ 图片继续正常显示（没有变成占位符）
- ✅ 没有500错误

---

## 📊 修复对比

| 功能 | 修改前 | 修改后 |
|------|--------|--------|
| **图片显示** | ❌ 显示404或占位符 | ✅ 自动显示base64图片 |
| **图片格式** | ❌ AI随意生成格式 | ✅ 严格要求+自动修正 |
| **飞书导出标题** | ✅ 有标题 | ✅ 有标题 |
| **飞书导出文本** | ❌ 没有文本 | ✅ 完整文本 |
| **飞书导出图片** | ❌ 没有图片 | ✅ 完整图片 |

---

## 🔍 调试方法

### 如果图片还是不显示：

**检查1：后端日志**
运行 `python backend_py/main.py` 的终端中应该看到：
```
Generated text length: 825
After format fix: 825
```

**检查2：前端Console**
按F12，Console中应该看到：
```
Replacing image_1 with base64 data (length: 123456)
```

如果看到：
```
No preview images, rendering markdown as-is
```
说明图片数据没有加载！

**检查3：生成的内容**
在Console中运行：
```javascript
console.log(article)
```

搜索 `image`，应该看到：
```markdown
![产品外观](image_1)  ← 正确格式
```

如果看到：
```markdown
![产品外观](image1.jpg)  ← 错误格式
```
说明格式修正没生效，可能是后端没重启。

---

### 如果飞书文档还是没内容：

**检查1：后端日志**
应该看到：
```
Upload image 1 response: {code: 0, ...}
Image 1 uploaded successfully: xxxxx
Create blocks response: {code: 0, ...}
```

**检查2：请求参数**
在F12 Network标签中，找到 `POST /api/documents/create` 请求

查看Request Payload：
- `title`: 文档标题
- `content`: 应该有很长的文本
- `images`: 应该有图片数据

如果 `content` 是空的或很短，说明前端没正确传参。

**检查3：飞书API响应**
在后端日志中查找：
```
Create document response: {code: 0, ...}
Create blocks response: {code: 0, ...}
```

如果 `code` 不是 0，说明飞书API调用失败。

---

## 💡 常见问题

### Q1：图片显示后又变成占位符了
**A:** 检查是否点了"重置"按钮，重置会清空 `previewImages`

### Q2：创建飞书副本成功，但图片是灰色的
**A:** 图片上传失败，检查：
- 飞书应用是否有 `drive:drive` 权限
- 网络连接是否正常
- 图片大小是否超限

### Q3：创建的飞书文档格式很乱
**A:** 可能是Markdown解析问题，检查：
- 是否有多余的空行
- 是否有特殊字符
- 可以手动在飞书中调整

---

## ✅ 修复完成检查清单

完成以下所有项，说明修复成功：

- [ ] 后端已重启（`python backend_py/main.py`）
- [ ] 前端已刷新（`Ctrl + Shift + R`）
- [ ] 生成文章时图片自动显示
- [ ] 图片不是404或占位符
- [ ] 创建飞书副本有完整文本
- [ ] 创建飞书副本有完整图片
- [ ] 多轮对话图片持续显示
- [ ] 没有500错误

**如果所有都✅，恭喜！修复成功！** 🎉

---

## 📝 技术细节

### 图片占位符格式规范

**标准格式：**
```markdown
![图片描述](image_N)
```
其中 N 是数字，从1开始

**正则表达式：**
```javascript
// 前端匹配
const placeholderRegex = /!\[([^\]]*)\]\(image_(\d+)\)/g

// 后端修正
re.sub(r'!\[([^\]]*)\]\(image(\d+)\.(?:jpg|png|jpeg|gif)\)', r'![\1](image_\2)', text)
```

### 飞书block_type对照表

| block_type | 含义 | 示例 |
|-----------|------|------|
| 1 | 文本 | 普通段落 |
| 2 | 一级标题 | `# 标题` |
| 3 | 二级标题 | `## 标题` |
| 4 | 三级标题 | `### 标题` |
| 27 | 图片 | 图片块 |

---

**现在开始测试吧！** 🚀

有任何问题随时告诉我！

