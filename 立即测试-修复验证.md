# 🧪 立即测试：验证修复

## ✅ 后端已启动

后端服务已成功运行在：**http://localhost:8000**

---

## 🎯 测试步骤

### 步骤1：刷新前端（如果正在运行）

如果前端已在运行（http://localhost:3000），**按 `Ctrl + Shift + R` 强制刷新页面**。

如果前端未运行，打开新终端：
```bash
cd frontend
npm run dev
```

---

### 步骤2：测试图片自动显示

1. 打开 http://localhost:3000
2. 使用飞书登录
3. 选择一个**包含图片**的文档
4. 在创作指令框输入：
   ```
   根据图片内容，创作一篇产品介绍，把图片智能地插入到合适的位置
   ```
5. 点击"生成"

**✅ 预期结果：**
- 文章生成成功
- **图片立即显示**在文章中（不需要额外操作！）
- 看到蓝色提示框："✅ AI已分析图片内容..."
- 图片占位符 `![...](image_N)` 被替换为实际图片

**❌ 如果失败：**
- 查看浏览器F12 Console是否有错误
- 查看后端终端日志

---

### 步骤3：测试多轮对话（重点！）

在生成的文章下方，继续输入：

**第一轮精修：**
```
把第二张图片移到文章开头
```
点击发送

**✅ 预期结果：**
- 文章成功更新
- **不会出现500错误！**
- 图片位置被调整
- 图片继续正常显示

**第二轮精修：**
```
为每张图片添加更详细的说明
```

**第三轮精修：**
```
把文章语气改得更专业一些
```

**✅ 预期结果：**
- ✅ 每一轮都能成功精修
- ✅ 不会出现500错误
- ✅ 图片一直正常显示
- ✅ 可以无限轮对话

---

## 🎯 核心验证点

### 验证1：图片自动显示 ✨
**修复前**：必须点"预览排版"按钮才能看到图片  
**修复后**：生成后立即看到图文并茂的文章

### 验证2：多轮对话不报错 ✨
**修复前**：第二轮对话就500错误（get_gemini_config not defined）  
**修复后**：可以进行无限轮对话，支持千问VL

---

## 📊 后端日志参考

### 首次生成时，应看到：
```
AI Create request received: doc_id=..., blocks_count=7
Using AI Provider: qwen
Generated prompt length: 291
Number of images: 1
Calling Qwen VL API... (timeout=60s, images=1)
Added image 1 to content
Qwen VL API response received successfully
Generated text length: 825
```

### 多轮对话时，应看到：
```
Refine using AI Provider: qwen
Calling Qwen VL API... (timeout=60s, images=1)
Qwen VL API response received successfully
Refined text length: 950
```

### 不应该再看到：
- ❌ `UnicodeDecodeError`
- ❌ `get_gemini_config is not defined`
- ❌ `500 Internal Server Error`

---

## 🐛 如果还有问题

### 问题：多轮对话还是500错误
**解决方案：**
1. 确认后端已重启（查看终端，应该有新的启动信息）
2. 查看后端日志的具体错误
3. 确认 `backend_py/routers/ai.py` 已保存修改

### 问题：图片还是不显示
**解决方案：**
1. 打开浏览器F12 Console
2. 看是否有请求 `/api/ai/preview/` 接口
3. 看返回的 `images` 数组是否有数据
4. 强制刷新页面（Ctrl + Shift + R）

### 问题：后端启动有错误
**解决方案：**
查看后端终端的完整错误信息，发给我。

---

## 🎉 成功标志

如果看到以下所有现象，说明修复成功：

1. ✅ 首次生成：文章和图片一起出现
2. ✅ 蓝色提示框显示："AI已分析图片内容，并智能地将图片插入到最合适的位置"
3. ✅ 第二轮对话：不会500错误，文章成功更新
4. ✅ 第三轮、第四轮...：都能正常工作
5. ✅ 后端日志显示："Using AI Provider: qwen" 和 "Qwen VL API response received successfully"

---

**开始测试吧！** 🚀

有任何问题随时告诉我！

